<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>–ö–∏–Ω–¥–∑–∏ –•–∞–∫–∞—Ä–∏ ¬∑ –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        /* ---------- –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò ---------- */
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: #0f1a1f;
            color: #e6e9ef;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* ---------- –§–û–ù (–¢–ê–ù–¶–£–Æ–©–ò–ô –•–ê–ö–ê–†–ò) ---------- */
        .background-gif {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.2;
            pointer-events: none;
            object-fit: cover;
        }

        /* ---------- –ì–ò–§–ö–ê –†–ê–°–®–ò–†–ï–ù–ò–Ø –¢–ï–†–†–ò–¢–û–†–ò–ò ---------- */
        .expansion-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        .expansion-overlay img { 
            max-width: 90%; 
            max-height: 90%; 
            border-radius: 20px; 
            box-shadow: 0 0 40px gold; 
        }
        .expansion-overlay.show { display: flex; }

        /* ---------- –ö–û–ù–¢–ï–ô–ù–ï–† –ì–ò–§–ö–ò –î–ñ–ï–ö–ü–û–¢–ê (–í–°–ï–ì–î–ê –í –¶–ï–ù–¢–†–ï) ---------- */
        .jackpot-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .jackpot-container.show {
            visibility: visible;
            opacity: 1;
        }
        .jackpot-gif {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
            border: 4px solid gold;
            display: block;
        }

        /* ---------- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† ---------- */
        .container {
            position: relative;
            z-index: 2;
            max-width: 800px;
            width: 100%;
            background: rgba(20, 30, 35, 0.85);
            backdrop-filter: blur(8px);
            border-radius: 36px;
            padding: 30px 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            border: 1px solid #3e5a63;
        }

        h1 {
            text-align: center;
            font-size: 2em;
            margin-top: 0;
            margin-bottom: 10px;
            color: #f2d872;
            text-shadow: 0 0 5px #ffb347;
            letter-spacing: 2px;
        }
        .sub {
            text-align: center;
            margin-bottom: 30px;
            color: #aac7d4;
            font-style: italic;
        }
        .buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }
        .btn {
            border: none;
            background: #2e4a55;
            padding: 16px 30px;
            font-size: 1.6em;
            border-radius: 60px;
            color: white;
            font-weight: bold;
            box-shadow: 0 10px 0 #0f1f24, 0 6px 20px black;
            transition: 0.07s;
            cursor: pointer;
            flex: 0 1 auto;
            min-width: 160px;
            border: 1px solid #6f9faa;
        }
        .btn:active {
            transform: translateY(10px);
            box-shadow: 0 2px 0 #0f1f24, 0 6px 20px black;
        }

        /* ---------- –ó–û–ù–ê –ê–ù–ò–ú–ê–¶–ò–ò –ö–£–ë–û–í ---------- */
        .dice-area {
            background: #0b171c;
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #3e7b8a;
            box-shadow: inset 0 0 15px #00000070;
            min-height: 250px;
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        .dice-area.active { display: flex; }

        .phase-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #ffd966;
            text-shadow: 0 0 5px #b37300;
            text-align: center;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }

        .d20-row, .d8-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .dice-label {
            font-size: 1.2em;
            color: #aac7d4;
            margin-right: 10px;
        }

        .dice {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2em;
            font-weight: bold;
            color: white;
            box-shadow: 0 8px 0 #0f1f24, 0 5px 15px black;
            border: 2px solid #6f9faa;
            transition: 0.1s, background 0.3s, border 0.3s;
        }

        /* –¶–≤–µ—Ç–∞ –∫—É–±–æ–≤ */
        .dice.color-green { background: #2e7d32; border-color: #a5d6a5; }
        .dice.color-red { background: #b71c1c; border-color: #ff8a80; }
        .dice.color-gold { background: #b76e2e; border-color: #ffd95a; }
        .dice.color-rainbow {
            background: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #80ff00, #00ffff, #0080ff, #8000ff);
            border-color: white;
            text-shadow: 0 0 5px black;
        }
        .dice.d20 { background: #4a2e55; border-color: #aa6f9f; }
        .dice.d20.color-green { background: #1f5a23; }
        .dice.d20.color-red { background: #8e1a1a; }
        .dice.d20.color-gold { background: #8f5a24; }
        .dice.d20.color-rainbow { background: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #80ff00, #00ffff, #0080ff, #8000ff); }

        .dice.reroll-target {
            box-shadow: 0 0 15px #ffb347;
            border-color: gold;
        }

        /* ---------- –ê–ù–ò–ú–ê–¶–ò–Ø –ü–û–ö–ê–ß–ò–í–ê–ù–ò–Ø ---------- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-2px, 0px) rotate(-2deg); }
            40% { transform: translate(2px, -1px) rotate(2deg); }
            60% { transform: translate(-1px, 2px) rotate(0deg); }
            80% { transform: translate(1px, -1px) rotate(2deg); }
            100% { transform: translate(0px, 0px) rotate(0deg); }
        }
        .dice.shake {
            animation: shake 0.4s infinite;
        }
        .jackpot-container.shake .jackpot-gif {
            animation: shake 0.5s infinite;
        }

        /* ---------- –¢–ï–ö–°–¢–û–í–´–ô –í–´–í–û–î ---------- */
        .output {
            background: #0b171c;
            border-radius: 24px;
            padding: 25px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            line-height: 1.6;
            border: 1px solid #3e7b8a;
            color: #d6edf0;
            box-shadow: inset 0 0 15px #00000070;
            min-height: 200px;
        }

        /* ---------- –°–¢–û–ü-–ö–ù–û–ü–ö–ê ---------- */
        .stop-button {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        .stop-btn {
            background: #a13d3d;
            border: none;
            padding: 12px 30px;
            font-size: 1.2em;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 0 #4f1e1e;
            transition: 0.07s;
            border: 1px solid #d47c7c;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .stop-btn:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #4f1e1e;
        }

        /* ---------- –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –ó–í–£–ö–ê ---------- */
        .sound-toggle {
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            color: #aac7d4;
            font-size: 0.9em;
        }
        .footer {
            margin-top: 15px;
            text-align: right;
            color: #7799a0;
            font-size: 0.85em;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- –§–û–ù: —Ç–∞–Ω—Ü—É—é—â–∏–π –•–∞–∫–∞—Ä–∏ (–∑–∞–º–µ–Ω–∏ –ø—É—Ç—å) -->
    <img class="background-gif" src="hakari-dance.gif" alt="Hakari dance" loop="true">

    <!-- –ì–ò–§–ö–ê –†–ê–°–®–ò–†–ï–ù–ò–Ø –¢–ï–†–†–ò–¢–û–†–ò–ò -->
    <div id="expansionOverlay" class="expansion-overlay">
        <img src="expansion.gif" alt="–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏">
    </div>

    <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –ì–ò–§–ö–ò –î–ñ–ï–ö–ü–û–¢–ê (–í–°–ï–ì–î–ê –í –¶–ï–ù–¢–†–ï) -->
    <div id="jackpotContainer" class="jackpot-container">
        <img id="jackpotGif" class="jackpot-gif" src="jackpot.gif" alt="JACKPOT!">
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† -->
    <div class="container">
        <h1>üö™üé± –ö–∏–Ω–¥–∑–∏ –•–∞–∫–∞—Ä–∏</h1>
        <div class="sub">–°—Ç–≤–æ—Ä—á–∞—Ç—ã–µ –¥–≤–µ—Ä–∏ ¬∑ –ó–∞–ø–∞—Å–Ω—ã–µ —à–∞—Ä—ã</div>
        <div class="buttons">
            <button class="btn" onclick="playGame('–î–≤–µ—Ä—å')">üö™ –î–≤–µ—Ä—å</button>
            <button class="btn" onclick="playGame('–®–∞—Ä')">üé± –®–∞—Ä</button>
        </div>

        <!-- –ó–û–ù–ê –ê–ù–ò–ú–ê–¶–ò–ò –ö–£–ë–û–í -->
        <div id="diceArea" class="dice-area">
            <div id="phaseTitle" class="phase-title">‚ö° –û—Å–Ω–æ–≤–Ω–æ–π –±—Ä–æ—Å–æ–∫ ‚ö°</div>
            <div class="d20-row">
                <span class="dice-label">d20:</span>
                <div id="animD20" class="dice d20">20</div>
            </div>
            <div class="d8-row">
                <span class="dice-label">3d8:</span>
                <div id="animD8_1" class="dice">1</div>
                <div id="animD8_2" class="dice">1</div>
                <div id="animD8_3" class="dice">1</div>
            </div>
        </div>

        <!-- –¢–ï–ö–°–¢–û–í–´–ô –í–´–í–û–î -->
        <div class="output" id="outputPanel">üé≤ –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
        
        <!-- –ö–ù–û–ü–ö–ê –û–°–¢–ê–ù–û–í–ö–ò –î–ñ–ï–ö–ü–û–¢–ê -->
        <div id="stopJackpotContainer" class="stop-button hidden">
            <button id="stopJackpotBtn" class="stop-btn" onclick="stopJackpot()">
                üîá –ó–∞–∫–æ–Ω—á–∏—Ç—å –î–∂–µ–∫–ø–æ—Ç
            </button>
        </div>
        
        <div class="sound-toggle">
            <span>üîä –ó–≤—É–∫ –¥–∂–µ–∫–ø–æ—Ç–∞</span>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="soundCheckbox" checked> –í–∫–ª.
            </label>
        </div>
        <div class="footer">–±–∞–ª–∞–Ω—Å 30% ¬∑ —Ü–≤–µ—Ç–Ω—ã–µ –∫—É–±—ã ¬∑ —Ç—Ä—è—Å–∫–∞ ¬∑ –≥–∏—Ñ–∫–∞ –Ω–∞ 18—Å</div>
    </div>

    <!-- –ê–£–î–ò–û -->
    <audio id="jackpotSound" preload="auto" loop="false">
        <source src="tuca-donka.mp3" type="audio/mpeg">
    </audio>
    <audio id="expansionSound" preload="auto">
        <source src="expansion.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ---------- –ù–ê–°–¢–†–û–ô–ö–ò ----------
        const JACKPOT_GIF_DELAY = 19400; // ‚¨ÖÔ∏è 19.4 —Å–µ–∫—É–Ω–¥ ‚Äì —Ä–æ–≤–Ω–æ –≤ –º–æ–º–µ–Ω—Ç —Å–ª–æ–≤–∞ "–î–ñ–ï–ö–ü–û–¢!"

        // ---------- –¢–ê–ë–õ–ò–¶–´ –ë–ê–õ–ê–ù–°–ê (30%) ----------
        const COLOR_TABLE = [
            { lo: 1, hi: 10, name: "–ó–µ–ª—ë–Ω—ã–π", rerolls: 1 },
            { lo: 11, hi: 15, name: "–ö—Ä–∞—Å–Ω—ã–π", rerolls: 2 },
            { lo: 16, hi: 19, name: "–ó–æ–ª–æ—Ç–æ–π", rerolls: 4 },
            { lo: 20, hi: 20, name: "–†–∞–¥—É–∂–Ω—ã–π", rerolls: 0 }
        ];

        const EVENT_TABLE = [
            { lo: 1, hi: 9, name: "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ –≤–æ—Ä–æ—Ç–∞", bonus: 1 },
            { lo: 10, hi: 14, name: "–ö–æ–Ω–∫—É—Ä—Å –ø–∞—Å—Å–∞–∂–∏—Ä—Å–∫–∏—Ö –º–µ—Å—Ç", bonus: 2 },
            { lo: 15, hi: 18, name: "–ü–æ—Ç–µ—Ä–ø–∏—Ç–µ –¥–æ –≤–∞–Ω–Ω–æ–π", bonus: 4 },
            { lo: 19, hi: 100, name: "–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–µ–∑–¥", bonus: 6 }
        ];

        // ---------- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ----------
        function d20() { return Math.floor(Math.random() * 20) + 1; }
        function d8()  { return Math.floor(Math.random() * 8) + 1; }
        function roll3d8() { return [d8(), d8(), d8()]; }

        function evaluateRoll(rolls) {
            const [a,b,c] = rolls;
            if (a === b && b === c) return "–î–ñ–ï–ö–ü–û–¢";
            if (a === b || a === c || b === c) return "–†–ò–ò–ß–ò";
            return "–ù–ò–ß–ï–ì–û";
        }

        function scoreRoll(rolls) {
            const type = evaluateRoll(rolls);
            let rank = (type === "–î–ñ–ï–ö–ü–û–¢") ? 2 : (type === "–†–ò–ò–ß–ò") ? 1 : 0;
            return { rank, sum: rolls.reduce((s,v)=>s+v,0) };
        }

        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ü–ï–†–ï–ë–†–û–°–û–í (–ó–ê–ü–†–ï–©–ï–ù–ê –ú–ê–°–ö–ê 7)
        function optimizeRolls(initialRolls, maxRerolls) {
            let bestFinal = initialRolls.slice();
            let bestScore = scoreRoll(initialRolls);
            let bestHistory = [];
            let bestRerollsUsed = 0;

            function dfs(current, remaining, steps, stepNum) {
                const curScore = scoreRoll(current);
                if (curScore.rank > bestScore.rank || 
                   (curScore.rank === bestScore.rank && curScore.sum > bestScore.sum)) {
                    bestFinal = current.slice();
                    bestScore = curScore;
                    bestHistory = steps.slice();
                    bestRerollsUsed = stepNum;
                }
                if (remaining === 0 || evaluateRoll(current) === "–î–ñ–ï–ö–ü–û–¢") return;

                for (let mask = 1; mask <= 6; mask++) {
                    const indices = [];
                    if (mask & 1) indices.push(0);
                    if (mask & 2) indices.push(1);
                    if (mask & 4) indices.push(2);
                    const newRolls = current.slice();
                    for (let i of indices) newRolls[i] = d8();
                    const newState = newRolls.slice();
                    const step = {
                        step: stepNum + 1,
                        indices: indices.map(i => i+1),
                        newRolls: newState.slice()
                    };
                    dfs(newState, remaining - 1, steps.concat([step]), stepNum + 1);
                }
            }

            dfs(initialRolls.slice(), maxRerolls, [], 0);
            return {
                initial: initialRolls.slice(),
                final: bestFinal,
                resultType: evaluateRoll(bestFinal),
                history: bestHistory,
                rerollsUsed: bestRerollsUsed
            };
        }

        // –£–†–ê–í–ù–ò–í–ê–ù–ò–ï
        function equalizeWithBonus(rolls, bonus) {
            let bestTarget = null;
            let bestCost = Infinity;
            let bestResult = null;
            for (let target = 1; target <= 8; target++) {
                const cost = Math.abs(rolls[0]-target) + Math.abs(rolls[1]-target) + Math.abs(rolls[2]-target);
                if (cost <= bonus) {
                    if (cost < bestCost || (cost === bestCost && target > bestTarget)) {
                        bestCost = cost;
                        bestTarget = target;
                        bestResult = [target, target, target];
                    }
                }
            }
            return bestResult ? { equalized: bestResult, jackpot: true } : { equalized: rolls.slice(), jackpot: false };
        }

        // ---------- –£–ü–†–ê–í–õ–ï–ù–ò–ï –¶–í–ï–¢–û–ú –ö–£–ë–û–í ----------
        function setDiceColor(colorName) {
            const d20El = document.getElementById('animD20');
            const d8Els = [
                document.getElementById('animD8_1'),
                document.getElementById('animD8_2'),
                document.getElementById('animD8_3')
            ];
            const colorClasses = ['color-green', 'color-red', 'color-gold', 'color-rainbow'];
            d20El.classList.remove(...colorClasses);
            d8Els.forEach(el => el.classList.remove(...colorClasses));
            
            let colorClass = '';
            switch(colorName) {
                case '–ó–µ–ª—ë–Ω—ã–π': colorClass = 'color-green'; break;
                case '–ö—Ä–∞—Å–Ω—ã–π': colorClass = 'color-red'; break;
                case '–ó–æ–ª–æ—Ç–æ–π': colorClass = 'color-gold'; break;
                case '–†–∞–¥—É–∂–Ω—ã–π': colorClass = 'color-rainbow'; break;
                default: return;
            }
            d20El.classList.add(colorClass);
            d8Els.forEach(el => el.classList.add(colorClass));
        }

        // ---------- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–£–ó–´–ö–û–ô, –ì–ò–§–ö–û–ô, –°–¢–û–ü-–ö–ù–û–ü–ö–û–ô ----------
        let jackpotTimer = null;
        let jackpotAudioPlaying = false;

        function startJackpotMusic() {
            const soundEnabled = document.getElementById('soundCheckbox').checked;
            if (!soundEnabled) return;
            const audio = document.getElementById('jackpotSound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log('–ê—É–¥–∏–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ'));
                jackpotAudioPlaying = true;
                document.getElementById('stopJackpotContainer').classList.remove('hidden');
                
                if (jackpotTimer) clearTimeout(jackpotTimer);
                jackpotTimer = setTimeout(() => {
                    showJackpotGif();
                }, JACKPOT_GIF_DELAY);
            }
        }

        function stopJackpotMusic() {
            const audio = document.getElementById('jackpotSound');
            if (audio && jackpotAudioPlaying) {
                audio.pause();
                audio.currentTime = 0;
                jackpotAudioPlaying = false;
            }
            document.getElementById('stopJackpotContainer').classList.add('hidden');
            if (jackpotTimer) {
                clearTimeout(jackpotTimer);
                jackpotTimer = null;
            }
            hideJackpotGif();
        }

        // ---------- –ì–ò–§–ö–ê –î–ñ–ï–ö–ü–û–¢–ê - –í–°–ï–ì–î–ê –í –¶–ï–ù–¢–†–ï ----------
        function showJackpotGif() {
            const container = document.getElementById('jackpotContainer');
            const gif = document.getElementById('jackpotGif');
            if (container && gif) {
                // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≥–∏—Ñ–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                const baseSrc = gif.src.split('?')[0];
                gif.src = baseSrc + '?t=' + Date.now();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —Ç—Ä—è—Å—ë–º
                container.classList.add('show');
                container.classList.add('shake');
                
                // –ß–µ—Ä–µ–∑ 1.5 —Å–µ–∫ —É–±–∏—Ä–∞–µ–º —Ç—Ä—è—Å–∫—É
                setTimeout(() => {
                    container.classList.remove('shake');
                }, 1500);
            }
        }

        function hideJackpotGif() {
            const container = document.getElementById('jackpotContainer');
            if (container) {
                container.classList.remove('show');
                container.classList.remove('shake');
            }
        }

        function stopJackpot() {
            stopJackpotMusic();
            const container = document.getElementById('jackpotContainer');
            if (container) container.classList.remove('shake');
        }

        // ---------- –ê–ù–ò–ú–ê–¶–ò–Ø –ö–£–ë–û–í (–° –ü–û–ö–ê–ß–ò–í–ê–ù–ò–ï–ú) ----------
        function animateDice(element, startVal, endVal, duration, isD8 = true) {
            return new Promise((resolve) => {
                element.classList.add('shake');
                const frames = 25;
                const stepTime = duration / frames;
                let currentFrame = 0;
                const interval = setInterval(() => {
                    if (currentFrame < frames - 1) {
                        const randomVal = isD8 ? Math.floor(Math.random() * 8) + 1 : Math.floor(Math.random() * 20) + 1;
                        element.textContent = randomVal;
                        currentFrame++;
                    } else {
                        clearInterval(interval);
                        element.textContent = endVal;
                        element.classList.remove('shake');
                        resolve();
                    }
                }, stepTime);
            });
        }

        async function animateD20Roll(element, finalValue, duration = 2000) {
            await animateDice(element, 1, finalValue, duration, false);
        }

        async function animateD8Roll(elements, finalValues, duration = 2500) {
            const promises = elements.map((el, idx) => 
                animateDice(el, 1, finalValues[idx], duration, true)
            );
            await Promise.all(promises);
        }

        async function animateReroll(d8elements, indices, newValues, duration = 1200) {
            indices.forEach(i => d8elements[i].classList.add('reroll-target'));
            await new Promise(r => setTimeout(r, 200));
            const promises = indices.map(i => 
                animateDice(d8elements[i], 1, newValues[i], duration, true)
            );
            await Promise.all(promises);
            indices.forEach(i => d8elements[i].classList.remove('reroll-target'));
        }

        // ---------- –ì–õ–ê–í–ù–ê–Ø –ê–ù–ò–ú–ò–†–û–í–ê–ù–ù–ê–Ø –ò–ì–†–ê ----------
        async function playAnimated(command) {
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∂–µ–∫–ø–æ—Ç–∞
            stopJackpotMusic();
            hideJackpotGif();

            // –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
            await showExpansion();

            const diceArea = document.getElementById('diceArea');
            const phaseTitle = document.getElementById('phaseTitle');
            const outputPanel = document.getElementById('outputPanel');
            const d20El = document.getElementById('animD20');
            const d8Els = [
                document.getElementById('animD8_1'),
                document.getElementById('animD8_2'),
                document.getElementById('animD8_3')
            ];

            outputPanel.style.display = 'none';
            diceArea.classList.add('active');

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
            const d20val = d20();
            let color = null;
            for (let c of COLOR_TABLE) {
                if (d20val >= c.lo && d20val <= c.hi) {
                    color = { name: c.name, rerolls: c.rerolls, isRainbow: c.name === "–†–∞–¥—É–∂–Ω—ã–π" };
                    break;
                }
            }
            if (!color) return;

            setDiceColor(color.name);

            // –†–∞–¥—É–≥–∞ ‚Äî –∞–≤—Ç–æ-–¥–∂–µ–∫–ø–æ—Ç
            if (color.isRainbow) {
                diceArea.classList.remove('active');
                outputPanel.style.display = 'block';
                outputPanel.innerText = "üé≤ d20: 20 | –†–∞–¥—É–∂–Ω—ã–π\n–†–∞–¥—É–∂–Ω—ã–π | –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –î–ñ–ï–ö–ü–û–¢ üîä";
                startJackpotMusic();
                return;
            }

            const initial = roll3d8();
            const opt = optimizeRolls(initial, color.rerolls);

            // –ó–ê–ü–£–°–ö –ú–£–ó–´–ö–ò ‚Äî —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–¥ –∞–Ω–∏–º–∞—Ü–∏–µ–π
            startJackpotMusic();

            // 1. –û—Å–Ω–æ–≤–Ω–æ–π –±—Ä–æ—Å–æ–∫
            phaseTitle.innerText = '‚ö° –û—Å–Ω–æ–≤–Ω–æ–π –±—Ä–æ—Å–æ–∫ ‚ö°';
            await animateD20Roll(d20El, d20val, 2000);
            await animateD8Roll(d8Els, opt.initial, 2500);
            await new Promise(r => setTimeout(r, 300));

            // 2. –ü–µ—Ä–µ–±—Ä–æ—Å—ã
            for (let i = 0; i < opt.history.length; i++) {
                const step = opt.history[i];
                phaseTitle.innerText = `üîÑ –ü–µ—Ä–µ–±—Ä–æ—Å ${step.step} –∏–∑ ${color.rerolls} üîÑ`;
                const indices = step.indices.map(i => i - 1);
                const newVals = step.newRolls;
                await animateReroll(d8Els, indices, newVals, 1200);
                await new Promise(r => setTimeout(r, 200));
            }

            // –§–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            for (let i = 0; i < 3; i++) {
                if (d8Els[i].textContent != opt.final[i]) {
                    d8Els[i].textContent = opt.final[i];
                }
            }

            // –ï—Å–ª–∏ –Ω–µ –¥–∂–µ–∫–ø–æ—Ç –∏ –Ω–µ —Ä–∏–∏—á–∏ ‚Äî –º—É–∑—ã–∫–∞ —Å—Ç–æ–ø
            if (opt.resultType !== "–î–ñ–ï–ö–ü–û–¢" && opt.resultType !== "–†–ò–ò–ß–ò") {
                stopJackpotMusic();
            }

            await new Promise(r => setTimeout(r, 400));

            // ---------- –†–ò–ò–ß–ò ----------
            let riichiLine = '';
            if (opt.resultType === "–†–ò–ò–ß–ò") {
                phaseTitle.innerText = 'üé≤ –°–æ–±—ã—Ç–∏–µ: –†–ò–ò–ß–ò üé≤';
                
                const eventD20 = d20();
                const eventRoll = eventD20 + color.rerolls;
                let event = null;
                for (let e of EVENT_TABLE) {
                    if (eventRoll >= e.lo && eventRoll <= e.hi) {
                        event = { name: e.name, bonus: e.bonus };
                        break;
                    }
                }
                if (!event) event = { name: "–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–µ–∑–¥", bonus: 6 };

                await animateD20Roll(d20El, eventD20, 1500);

                const riichiRolls = roll3d8();
                await animateD8Roll(d8Els, riichiRolls, 2000);

                phaseTitle.innerText = `‚ú® –£—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ (+${event.bonus}) ‚ú®`;
                const eq = equalizeWithBonus(riichiRolls, event.bonus);
                for (let i = 0; i < 3; i++) {
                    d8Els[i].textContent = eq.equalized[i];
                }
                d8Els.forEach(el => el.classList.add('reroll-target'));
                await new Promise(r => setTimeout(r, 600));
                d8Els.forEach(el => el.classList.remove('reroll-target'));

                const riichiResult = eq.jackpot ? "–î–ñ–ï–ö–ü–û–¢" : "–ù–ò–ß–ï–ì–û";
                riichiLine = `–†–∏–∏—á–∏ | d20+${color.rerolls}: ${eventRoll} | ${event.name} (+${event.bonus}) | 3d8: ${riichiRolls.join(' ')} ‚Üí —É—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ: ${eq.equalized.join(' ')} | ${riichiResult}`;
                
                if (eq.jackpot) {
                    riichiLine += ' üîä';
                } else {
                    stopJackpotMusic();
                }
            }

            // ---------- –ó–ê–í–ï–†–®–ï–ù–ò–ï ----------
            diceArea.classList.remove('active');
            outputPanel.style.display = 'block';

            let lines = [];
            lines.push(`üé≤ d20: ${d20val} | ${color.name} (${color.rerolls} –ø–µ—Ä–µ–±—Ä–æ—Å${color.rerolls===1?'' : '–∞'})`);
            lines.push(`–ù–∞—á–∞–ª—å–Ω—ã–µ 3d8: ${opt.initial.join(' ')}`);
            if (opt.history.length > 0) {
                let states = [opt.initial.join(' ')];
                for (let step of opt.history) states.push(step.newRolls.join(' '));
                lines.push(`–ü–µ—Ä–µ–±—Ä–æ—Å—ã: ${states.join(' > ')}`);
            }
            let finalStr = `${color.name} (${color.rerolls}) | d20: ${d20val} | 3d8: ${opt.final.join(' ')} ‚Üí ${opt.resultType}`;
            if (opt.resultType === "–î–ñ–ï–ö–ü–û–¢") {
                finalStr += ' üîä';
            }
            lines.push(finalStr);
            if (riichiLine) lines.push(riichiLine);

            outputPanel.innerText = lines.join('\n');
        }

        // ---------- –†–ê–°–®–ò–†–ï–ù–ò–ï –¢–ï–†–†–ò–¢–û–†–ò–ò ----------
        function showExpansion() {
            return new Promise((resolve) => {
                const overlay = document.getElementById('expansionOverlay');
                const sound = document.getElementById('expansionSound');
                overlay.classList.add('show');
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.log('–ù–µ—Ç –∑–≤—É–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è'));
                }
                setTimeout(() => {
                    overlay.classList.remove('show');
                    resolve();
                }, 1800);
            });
        }

        // ---------- –û–ë–Å–†–¢–ö–ê –î–õ–Ø –ö–ù–û–ü–û–ö ----------
        function playGame(command) {
            playAnimated(command).catch(console.error);
        }
    </script>
</body>
</html>